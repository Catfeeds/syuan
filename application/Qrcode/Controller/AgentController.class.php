<?php/** * 会员中心 */namespace Qrcode\Controller;use Common\Controller\MemberbaseController;class AgentController extends MemberbaseController {	function _initialize(){		parent::_initialize();        if($this->user['user_type'] != 3) {            $this->error('只有企业用户能够使用该功能！');        }	}	public function index() {        $where = array('uid'=>$this->user['id']);        $totalsize = M('Qrcode_company')->where($where)->count();        import('Page');        if($pagesize == 0) {            $pagesize = 20;        }        $PageParam = C("VAR_PAGE");        $page = new \Page($totalsize,$pagesize);        $page->setLinkWraper("li");        $page->__set("PageParam", $PageParam);        $page->SetPager('default', $pagetpl, array("listlong" => "9", "first" => "首页", "last" => "尾页", "prev" => "上一页", "next" => "下一页", "list" => "*", "disabledclass" => ""));        $list = M('Qrcode_company')->where($where)->order('id desc')->limit($page->firstRow . ',' . $page->listRows)->select();        $this->assign('list', $list);        $this->assign('page', $page->show('default'));    	$this->display();    }    public function add() {        if(empty($_POST)) {            $id = I('id', 0, 'int');            if($id > 0) {                $info = M('Qrcode_company')->find($id);                $this->assign('info', $info);            }            $this->display();        } else {            $name = I('name', '', 'trim');            $id   = I('id', 0, 'int');            if(!$name) {                $this->error('请输入公司名称！');            }            if(M('Qrcode_company')->where(array('name'=>$name,'uid'=>$this->user['id']))->count()) {                $this->error('已经添加该公司！');            }            if(!$id) {                $data = array(                    'name' => $name,                    'uid'  => $this->user['id'],                    'createtime' => date('Y-m-d H:i:s'),                );                if(M('Qrcode_company')->add($data)) {                    $this->success('添加成功!',UU('index'));                } else {                    $this->error('添加失败！');                }            } else {                $data = array(                    'name' => $name,                );                if(M('Qrcode_company')->where(array('id'=>$id))->save($data)!==false) {                    $this->success('编辑成功!',UU('index'));                } else {                    $this->error('编辑失败！');                }            }        }    }    public function bindlist() {        $id = I('id', 0, 'int');        $where = array('bindid' => $id);        $totalsize = M('Qrcode_bind')->where($where)->count();        import('Page');        if($pagesize == 0) {            $pagesize = 20;        }        $PageParam = C("VAR_PAGE");        $page = new \Page($totalsize,$pagesize);        $page->setLinkWraper("li");        $page->__set("PageParam", $PageParam);        $page->SetPager('default', $pagetpl, array("listlong" => "9", "first" => "首页", "last" => "尾页", "prev" => "上一页", "next" => "下一页", "list" => "*", "disabledclass" => ""));        $list = M('Qrcode_bind')->where($where)->order('id desc')->limit($page->firstRow . ',' . $page->listRows)->select();        $users = $uids = array();        foreach($list as $k => $v) {            $uids[$v['uid']] = $v['uid'];        }        if($uids) {            $users = M('Users')->where(array('id'=>array('in',$uids)))->getField('id,user_nicename,mobile');        }        $this->assign('list', $list);        $this->assign('users', $users);        $this->assign('page', $page->show('default'));        $this->display();    }    public function unbind() {        $id = I('id', 0, 'int');        $bindid = I('bindid', 0, 'int');        if($id > 0) {            if(M('Qrcode_bind')->where(array('id'=>$id,'bindid'=>$bindid))->delete() !== false) {                $this->success('解绑成功！', UU('bindlist',array('id'=>$bindid)));            } else {                $this->error('解绑失败！');            }        }    }    public function audit_pass(){        $id = I('id', 0, 'int');        $bindid = I('bindid', 0, 'int');        if($id > 0) {            $resture = M('Qrcode_bind')->where(array('id'=>$id,'bindid'=>$bindid))->save(array('status'=>1));            if( $resture !== false) {                $this->success('审核成功！', UU('bindlist',array('id'=>$bindid)));            } else {                $this->error('审核失败！');            }        }    }    public function disabled() {        $id     = I('id', 0, 'int');        $status = I('status', 0, 'int');        if($id > 0) {            if(M('Qrcode_company')->where(array('id'=>$id))->save(array('status'=>$status))!==false) {                $this->success('操作成功！');            } else {                $this->error('操作失败！');            }        } else {            $this->error('操作失败！');        }    }}