<?phpnamespace Qrcode\Controller;use Common\Controller\AdminbaseController;class AdminQrcodeController extends AdminbaseController {	function _initialize() {		parent::_initialize();		$this->status_arr = array(			'1' => '待审核',			'2' => '印刷中',			'3' => '已完成',			'4' => '已取消'		);	}	public function index() {		$where  = array();		$name   = I('name', '', 'trim');		if($name) {			$where['status'] = $status;		} 		$count = M("Redbag_order")->where($where)->count();    	$page  = $this->page($count, 20);    	$list  = M("Redbag_order")->where($where)->order("id DESC")->limit($page->firstRow . ',' . $page->listRows)->select();    	$uids = $users = array();		foreach ($list as $key => $value) {			$uids[$value['uid']] = $value['uid'];			$uids[$value['adminid']] = $value['adminid'];            $list[$key]['isend'] = strtotime($value['endtime'].' 23:59:59') < time() ? 1 : 0;            $list[$key]['used'] = M('Redbag')->where(array('orderid'=>$value['id'],'pay_status'=>1))->count('id');        }		if($uids) {			$users = M('Users')->where(array('id' => array('in', $uids)))->getField('id,user_nicename');		}		$this->assign('users', $users);		$this->assign('list', $list);		$this->assign('status', $status);		$this->assign('name', $name);		$this->assign('page', $page->show('Admin'));		$this->display();	}	public function check() {		$id = I('id', 0, 'int');		$status = I('status', 0, 'int');		if($id > 0) {			if($status != 3 && $status != 2) {				$this->error('审核失败！');			}			$info = M('Redbag_order')->find($id);			if(!$info) {				$this->error('信息不存在！');			}			if(M('Redbag_order')->where(array('id'=>$id))->save(array('status'=>$status,'adminid' => sp_get_current_admin_id()))!==false) {				if($status == 2) {					//生成二维码记录					$num   = $info['num'];					$data  = array();					$start = M('Redbag')->where(array('orderid'=>$id))->max('listorder');					for($i=0;$i<$num;$i++) {						$start++;						$key = sp_random_string(12);						while(M('Redbag')->where(array('code'=>$key))->count()) {							$key = sp_random_string(12);						}						/*$url = 'http://'.$_SERVER['SERVER_NAME'].'/qrcode.php?data='.urlencode(UU('qrcode/redbag/index',array('code'=>$key),false,true));						$img = file_get_contents($url);						if(!is_dir('./data/qrcode/'.$id.'/')) {							mkdir('./data/qrcode/'.$id.'/');						}						file_put_contents('./data/qrcode/'.$id.'/'.$i.'.png', $img);*/						$data[] = array(							'uid'        => $info['uid'],							'amount'     => $info['amount'],							'winner'     => 0,							'code'       => $key,							'starttime'  => $info['starttime'],							'endtime'    => $info['endtime'],							'createtime' => date('Y-m-d H:i:s'),							'pay_status' => 0,							'orderid'    => $id,							'wish'       => $info['wish'],							'listorder'  => $start,						);					}					M('Redbag')->addAll($data);				}				$this->success('审核成功！');			} else {				$this->error('审核失败！');			}		}	}	public function detail() {		$id = I('id', 0, 'int');        if($id > 0) {            $list = M('Redbag')->where(array('orderid'=>$id,'pay_status'=>1))->select();            foreach($list as $k => $v) {                $list[$k]['nick'] = M('oauth_user')->where(array('openid'=>$v['winner']))->getField('name');            }            $this->assign('list', $list);            $this->display();        }	}	public function delete() {		$id = I('id', 0, 'int');		if($id > 0) {			if(M('Redbag_order')->delete($id)!==false) {				$this->success('删除成功！');			} else {				$this->error('删除失败！');			}		}	}}