<!DOCTYPE html>
<html>
<head>
<title>{$site_name}-生成二维码-会员中心</title>
<meta name="keywords" content="{$site_seo_keywords}" />
<meta name="description" content="{$site_seo_description}">
<link rel="stylesheet" type="text/css" href="__TMPL__Qrcode/Public/css/page.css"/>
<tc_include file="Public:head" />
</head>

<body class="body-white" id="top">
	<tc_include file="Public:nav" />

	<div class="container tc-main">
        <div class="row">
            <div class="span2">
                <tc_include file="Public:usernav"/>
            </div>
            <div class="span10">
               <div class="tab-content">
                   	<div class="tab-pane active" id="one">
	                <form id="ff" class="form-horizontal js-forgot-form" action="{:leuu('Qrcode/center/batch_trace')}" method="post">
						<div class="control-group">
						  <label class="control-label" for="inputEmail">批次</label>
						  <div class="controls">
							<select class="span2" name="product" id="product">
								<option value="0">选择产品</option>
								<foreach name="product" item="val">
									<option value="{$val.pid}">{$val.name}</option>
								</foreach>
							</select>
							<select class="span2" id="batch" name="batch">
								<option value="0">选择批次</option>
							</select>
							<span class="help-inline"></span>
						  </div>
						</div>
						<div class="control-group">
						  <label class="control-label" for="field1">二维码</label>
						  <div class="controls">
							<input type="radio" name="method" value="1">
							<textarea name="qrcode" id="qrcode"></textarea>
							多码<br/><span class="text-error">&nbsp;&nbsp;&nbsp;&nbsp;每行输入一个码号</span>
							<br/><br/>
							<input type="radio" name="method" value="2">
							<input type="number" name="sblock" id="sblock" class="span2">-<input type="number" id="eblock" name="eblock" class="span2">
							分组<br/><span class="text-error">&nbsp;&nbsp;&nbsp;&nbsp;请输入码号中间的数字，例如：想修改ddccc63-2-1至ddccc63-3-20，那么只用输入2和3即可</span>
							<br/><br/>
							<input type="radio" name="method" value="3">
							<input type="number" name="slistorder" id="slistorder" class="span2">-<input type="number" id="elistorder" name="elistorder" class="span2">
							序列号<br/><span class="text-error">&nbsp;&nbsp;&nbsp;&nbsp;请输入码号最后的数字，例如：想修改ddccc63-2-1至ddccc63-3-20，那么只用输入1和20即可</span>
						  </div>
						</div>

						<div class="control-group">
							<label class="control-label" for=""></label>
							<div class="controls">
								<button class="btn btn-primary js-ajax-submit span4" type="button" style="margin-left: 0px" id="subbtn">批量设置溯源</button>
							</div>
						</div>
					<div id="trace" style="display:none;">
						<div style="margin-left:160px;">
							<h4 id="c"></h4>
							<div id="list">
								<ul>
									<table style="width:320px;" class="table table-bordered"></table>
								</ul>
								<div id="Pagination" class="right flickr"></div> 
							</div>
						</div>
						<div class="control-group">
						  <label class="control-label" for="inputEmail">身份</label>
						  <div class="controls">
							<input type="radio" name="identity" value="厂家">厂家
							<input type="radio" name="identity" value="代理商">代理商
							<span class="help-inline"></span>
						  </div>
						</div>
						<div class="control-group">
						  <label class="control-label" for="field1">公司名称</label>
						  <div class="controls">
							<select name="company">
							<foreach name="company" item="val">
								<option value="{$val.id}">{$val.name}</option>
							</foreach>
							</select>
						  </div>
						</div>
						<div class="control-group">
						  <label class="control-label" for="field1">发往地区</label>
						  <div class="controls">
							<select name="province" id="province">
								<option value="0">--省份--</option>
								<foreach name="province" item="val">
								<option value="{$val.name}" data-id="{$val.region_id}">{$val.name}</option>
								</foreach>
							</select>
							<select name="city" id="city">
								<option value="0">--城市--</option>
							</select>
						  </div>
						</div>
						<div class="control-group">
						  <label class="control-label" for="field1">溯源日期</label>
						  <div class="controls">
							<input type="text" name="sendtime" placeholder="请输入日期" value="{$date}" class="span4 js-date">
						  </div>
						</div>
						<div class="control-group">
							<label class="control-label" for=""></label>
							<div class="controls">
								<button class="btn btn-primary js-ajax-submit span4" type="button" style="margin-left: 0px" id="confirm">确认</button>
							</div>
						</div>
					</div>
				</form>
                   </div>

               </div>
            </div>
        </div>
		<tc_include file="Public:footer" />
	</div>
	<!-- /container -->
	<tc_include file="Public:scripts" />
	<script type="text/javascript" src="__TMPL__Qrcode/Public/js/jquery.pagination.js"></script>
	<script type="text/javascript">
	$('#qrcode').bind('click', function() {
		$("input[name='method']:eq(0)").attr("checked",'checked'); 
	});
	$('#sblock').bind('click', function() {
		$("input[name='method']:eq(1)").attr("checked",'checked'); 
	});
	$('#eblock').bind('click', function() {
		$("input[name='method']:eq(1)").attr("checked",'checked'); 
	});
	$('#slistorder').bind('click', function() {
		$("input[name='method']:eq(2)").attr("checked",'checked'); 
	});
	$('#elistorder').bind('click', function() {
		$("input[name='method']:eq(2)").attr("checked",'checked'); 
	});
	$('#confirm').click(function() {
		if(confirm('确认溯源吗！')) {
			$.post("{:leuu('Qrcode/center/add_trace')}",$('#ff').serialize(),function(data){
				if(data.result==true) {
					alert('溯源成功！');
					location.reload();
				} else {
					alert(data.msg);
				}
			},'json');
		}
	});
	$('#product').change(function() {
		var v = $(this).find(':selected').val();
		$.getJSON('{:U("ajax_batch")}', {pid:v}, function(data) {
			$('#batch option:gt(0)').remove();
			if(data.length > 0) {
				for(var i=0;i<data.length;i++) {
					$('#batch').append('<option value="'+data[i].id+'">'+data[i].batch+'</option>')
				}
			}
		});
	});
	$('#province').change(function() {
		var v = $(this).find(':selected').data('id');
		$.post("{:leuu('Qrcode/center/get_region')}",{pid:v},function(data) {
			$('#city option:gt(0)').remove();
			if(data.length > 0) {
				for(var i=0;i<data.length;i++) {
					$('#city').append('<option value="'+data[i].name+'">'+data[i].name+'</option>')
				}
			}
		},'json');
	});
	var pageIndex = 0;//页面索引初始值   
	var pageSize  = 25;
	var pcount = 0;
    //翻页调用   
    function PageCallback(index, jq) {             
        InitTable(index);  
    }
    //请求数据   
    function InitTable(pageIndex) {                                  
        $.ajax({   
            type: "POST",  
            dataType: "json",  
            url: "{:leuu('Qrcode/center/batch_trace')}?p="+(pageIndex+1),
            data: $('#ff').serialize(),                 
            success: function(data) {
                if(data.result==true) {
					$('#trace').show();
					$('#c').text('当前一共'+data.count+'个二维码！');
					if(data.count > 0) {
						pcount = data.count;
						$("#Pagination").pagination(pcount, {
							callback: PageCallback,  //PageCallback() 为翻页调用次函数。
							prev_text: "« 上一页",
							next_text: "下一页 »",
							items_per_page:pageSize,
							num_edge_entries: 2,       //两侧首尾分页条目数
							num_display_entries: 6,    //连续分页主体部分分页条目数
							current_page: pageIndex,   //当前页索引
					    });
					    $('#list table').empty();
					     $('#list table').append('<thead><th>码号</th><th>是否作废</th><th>是否溯源</th></thead>');
						for(var i=0;i<data.list.length;i++) {
							$('#list table').append('<tr><td>'+data.list[i].code+'</td><td>'+(data.list[i].isdel==1?'已作废':'未作废')+'</td><td>'+(data.list[i].already?'已溯源':'未溯源')+'</td></tr>');
						}
					}
				} else {
					alert(data.msg);
				}
            }  
        }); 
    }
	$('#subbtn').click(function(){
		InitTable(pageIndex);
	});
	</script>
</body>
</html>